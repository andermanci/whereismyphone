//= require underscore
//= require gmaps/google

<% if current_device %>
    <div class="container">

      <div class="row">
            <div class="col-sm-4">
                <div class="panel panel-primary">
                  <div class="panel-heading"><%= current_device.name %></div>
                  <div class="panel-body"><img src="https://d30y9cdsu7xlg0.cloudfront.net/png/83002-200.png" class="img-responsive" style="width:100%" alt="Image"></div>
                  <div class="panel-footer"><%= current_device.info %></div>
                </div>
              </a>
            </div>

        <% if session[:GPS].nil? || session[:GPS].to_s=='no' %>
        <%= button_to "Activate GPS", {:action => 'activate_GPS' } ,
                                {class: 'btn btn-success btn-lg '} %>
        <% else %>
        <%= button_to "Desactivate GPS", {:action => 'desactivate_GPS' } ,
                      {class: 'btn btn-warning btn-lg '} %>
        <% end %>
        <% if session[:alarm].nil? ||session[:alarm].to_s=='no' %>
        <%= button_to "Activate Alarm", { :action => 'activate_alarm' } ,
                      {class: 'btn btn-danger btn-lg '} %>
        <% else %>
        <%= button_to "Desactivate Alarm", {:action => 'desactivate_alarm' } ,
                      {class: 'btn btn-warning btn-lg '} %>
        <% end %>
    </div><br>

      <div style='width: 800px;'>
        <div id="map" style='width: 800px; height: 400px;'></div>
      </div>

      <div style='width: 800px;'>
        <div id="sidebar_builder" style='width: 800px; height: 400px;'></div>
      </div>
      <div id='sidebar_container'>
      </div>

      <h2>GPS SIGNAL DATES</h2>
      <table class="table table-hover">
        <thead class="thead-inverse">
        <tr>
          <th>Year</th>
          <th>Month</th>
          <th>Day</th>
        </tr>
        </thead>
        <tbody>


        </tbody>
      </table>





<% else %>
    <% redirect_to :root %>
<% end %>
</div><br><br>

<script>


    jQuery(document).ready(function($) {
        $(".clickable-row").click(function() {
            window.location = $(this).data("href");
        });
    });
</script>

<script>
    function createSidebarLi(json){
        return ("<li><a>" + json.name + "</a></li>");
    };

    function bindLiToMarker($li, marker){
        $li.on('click', function(){
            handler.getMap().setZoom(14);
            marker.setMap(handler.getMap()); //because clusterer removes map property from marker
            marker.panTo();
            google.maps.event.trigger(marker.getServiceObject(), 'click');
        })
    };

    function createSidebar(json_array){
        _.each(json_array, function(json){
            var $li = $( createSidebarLi(json) );
            $li.appendTo('#sidebar_container');
            bindLiToMarker($li, json.marker);
        });
    };

    handler = Gmaps.build('Google');
    handler.buildMap({ internal: {id: 'sidebar_builder'}}, function(){
        var json_array = [
            { lat: 40, lng: -80, name: 'Foo', infowindow: "I'm Foo" },
            { lat: 45, lng: -90, name: 'Bar', infowindow: "I'm Bar" },
            { lat: 50, lng: -85, name: 'Baz', infowindow: "I'm Baz" }
        ];

        var markers = handler.addMarkers(json_array);

        _.each(json_array, function(json, index){
            json.marker = markers[index];
        });

        createSidebar(json_array);
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
    });

</script>


<script src="//maps.google.com/maps/api/js?key=[AIzaSyADymuvSxOEri6cBmXxg8EBhbQu34Lq3GY]"></script>
<script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
<script src='//cdn.rawgit.com/printercu/google-maps-utility-library-v3-read-only/master/infobox/src/infobox_packed.js' type='text/javascript'></script> <!-- only if you need custom infoboxes -->